// Main Nextflow config file for nf-scrnaseq pipeline

// Global default params
params {
    // Input/Output
    input              = null           // Path to input data (10X folder, h5ad, or csv)
    input_format       = 'auto'         // 'auto', '10x', 'h5ad', 'csv'
    outdir             = './results'    // Output directory

    // QC thresholds
    min_genes          = 200            // Minimum genes per cell
    min_cells          = 3              // Minimum cells per gene
    max_genes          = 2500           // Maximum genes per cell
    max_counts         = null           // Maximum counts per cell (null = auto)
    max_pct_mt         = 5              // Maximum mitochondrial percentage

    // Gene filtering
    gene_type          = 'protein_coding' // Gene biotype to keep (null = all)
    exclude_mt         = false          // Exclude mitochondrial genes
    exclude_ribo       = false          // Exclude ribosomal genes

    // Doublet detection and decontamination
    run_doublet_detection = true        // Run doublet detection
    run_scrublet       = true           // Run Scrublet (Python)
    run_scdblfinder    = false          // Run scDblFinder (R) - slower
    run_decontx        = false          // Run DecontX (R) - slower
    scrublet_threshold = 'auto'         // Doublet threshold (auto or numeric)
    expected_doublet_rate = 0.06        // Expected doublet rate (typically 0.05-0.1)

    // Publishing options
    publish_dir_mode   = 'copy'         // 'copy', 'symlink', 'move'

    // Resource limits
    max_memory         = '128.GB'
    max_cpus           = 16
    max_time           = '240.h'

    // Help
    help               = false
}

// Process configuration
process {
    // Default resources
    cpus   = { check_max( 1 * task.attempt, 'cpus' ) }
    memory = { check_max( 6.GB * task.attempt, 'memory' ) }
    time   = { check_max( 4.h * task.attempt, 'time' ) }

    errorStrategy = { task.exitStatus in [143,137,104,134,139] ? 'retry' : 'finish' }
    maxRetries    = 1
    maxErrors     = '-1'

    // Process-specific resources
    withLabel: process_low {
        cpus   = { check_max( 2, 'cpus' ) }
        memory = { check_max( 4.GB * task.attempt, 'memory' ) }
        time   = { check_max( 2.h * task.attempt, 'time' ) }
    }

    withLabel: process_medium {
        cpus   = { check_max( 4, 'cpus' ) }
        memory = { check_max( 16.GB * task.attempt, 'memory' ) }
        time   = { check_max( 8.h * task.attempt, 'time' ) }
    }

    withLabel: process_high {
        cpus   = { check_max( 8, 'cpus' ) }
        memory = { check_max( 32.GB * task.attempt, 'memory' ) }
        time   = { check_max( 16.h * task.attempt, 'time' ) }
    }
}

// Execution profiles
profiles {
    debug {
        cleanup = false
    }

    conda {
        conda.enabled          = true
        conda.useMamba         = true
        conda.cacheDir         = "$HOME/.nextflow-conda-cache"
        docker.enabled         = false
        singularity.enabled    = false
        process.conda          = "${projectDir}/environment.yml"
    }

    docker {
        docker.enabled         = true
        docker.runOptions      = '-u $(id -u):$(id -g)'
        singularity.enabled    = false
        conda.enabled          = false
        process.container      = 'nf-scrnaseq:latest'
    }

    singularity {
        singularity.enabled    = true
        singularity.autoMounts = true
        docker.enabled         = false
        conda.enabled          = false
        process.container      = 'https://depot.galaxyproject.org/singularity/scanpy:1.9.3--pyhdfd78af_0'
    }

    test {
        params.input           = "${projectDir}/test_data/10x_sample"
        params.max_memory      = '6.GB'
        params.max_cpus        = 2
        params.max_time        = '1.h'

        // Adjusted QC parameters for sparse test data
        // Test data has cells with 20-60 genes, so use lower thresholds
        params.min_genes       = 10
        params.max_genes       = 100
        params.min_cells       = 1
        params.max_pct_mt      = 20

        // Disable doublet detection for small test dataset
        // Test data has only 50 cells, which is too small for reliable doublet detection
        params.run_doublet_detection = false
    }
}

// Capture exit codes from upstream processes when piping
process.shell = ['/bin/bash', '-euo', 'pipefail']

// Export these variables to prevent local Python/R libraries from conflicting
env {
    PYTHONNOUSERSITE = 1
    R_PROFILE_USER   = "/.Rprofile"
    R_ENVIRON_USER   = "/.Renviron"
}

// Manifest
manifest {
    name            = 'nf-scrnaseq'
    author          = 'salzcamino'
    homePage        = 'https://github.com/salzcamino/nf-scrnaseq'
    description     = 'Single-cell RNA-seq analysis pipeline using Nextflow'
    mainScript      = 'main.nf'
    nextflowVersion = '!>=22.10.0'
    version         = '0.1.0'
}

// Function to ensure that resource requirements don't go beyond maximum limit
def check_max(obj, type) {
    if (type == 'memory') {
        try {
            if (obj.compareTo(params.max_memory as nextflow.util.MemoryUnit) == 1)
                return params.max_memory as nextflow.util.MemoryUnit
            else
                return obj
        } catch (all) {
            println "   ### ERROR ###   Max memory '${params.max_memory}' is not valid! Using default value: $obj"
            return obj
        }
    } else if (type == 'time') {
        try {
            if (obj.compareTo(params.max_time as nextflow.util.Duration) == 1)
                return params.max_time as nextflow.util.Duration
            else
                return obj
        } catch (all) {
            println "   ### ERROR ###   Max time '${params.max_time}' is not valid! Using default value: $obj"
            return obj
        }
    } else if (type == 'cpus') {
        try {
            return Math.min( obj, params.max_cpus as int )
        } catch (all) {
            println "   ### ERROR ###   Max cpus '${params.max_cpus}' is not valid! Using default value: $obj"
            return obj
        }
    }
}
