/*
========================================================================================
    Modules Configuration
========================================================================================
    Module-specific publishing and configuration options
*/

process {
    publishDir = [
        path: { "${params.outdir}/${task.process.tokenize(':')[-1].tokenize('_')[0].toLowerCase()}" },
        mode: params.publish_dir_mode,
        saveAs: { filename -> filename.equals('versions.yml') ? null : filename }
    ]

    withName: 'SAMPLESHEET_CHECK' {
        publishDir = [
            path: { "${params.outdir}/pipeline_info" },
            mode: params.publish_dir_mode,
            saveAs: { filename -> filename.equals('versions.yml') ? null : filename }
        ]
    }

    withName: 'FASTQC' {
        ext.args = '--quiet'
        publishDir = [
            path: { "${params.outdir}/fastqc" },
            mode: params.publish_dir_mode,
            pattern: "*.{html,zip}"
        ]
    }

    withName: 'MULTIQC' {
        publishDir = [
            path: { "${params.outdir}/multiqc" },
            mode: params.publish_dir_mode
        ]
    }

    withName: 'STAR_GENOMEGENERATE' {
        publishDir = [
            path: { "${params.outdir}/genome" },
            mode: params.publish_dir_mode,
            enabled: false,
            saveAs: { filename -> filename.equals('versions.yml') ? null : filename }
        ]
    }

    withName: 'STAR_ALIGN' {
        ext.args = [
            '--outSAMtype BAM SortedByCoordinate',
            '--outSAMunmapped Within',
            '--outSAMattributes NH HI AS nM CB UB',
            '--readFilesCommand zcat',
            '--runRNGseed 0',
            '--outFilterMultimapNmax 20',
            '--alignSJoverhangMin 8',
            '--alignSJDBoverhangMin 1',
            '--outFilterMismatchNmax 999',
            '--outFilterMismatchNoverReadLmax 0.04',
            '--alignIntronMin 20',
            '--alignIntronMax 1000000',
            '--alignMatesGapMax 1000000'
        ].join(' ')
        publishDir = [
            [
                path: { "${params.outdir}/star" },
                mode: params.publish_dir_mode,
                pattern: "*.bam"
            ],
            [
                path: { "${params.outdir}/star/log" },
                mode: params.publish_dir_mode,
                pattern: "*.{out,tab}"
            ]
        ]
    }

    withName: 'SALMON_INDEX' {
        publishDir = [
            path: { "${params.outdir}/genome" },
            mode: params.publish_dir_mode,
            enabled: false
        ]
    }

    withName: 'SALMON_ALEVIN' {
        publishDir = [
            path: { "${params.outdir}/alevin" },
            mode: params.publish_dir_mode,
            pattern: "alevin_results"
        ]
    }

    withName: 'SEURAT_QC' {
        publishDir = [
            [
                path: { "${params.outdir}/qc" },
                mode: params.publish_dir_mode,
                pattern: "*.{html,pdf,png}"
            ],
            [
                path: { "${params.outdir}/filtered" },
                mode: params.publish_dir_mode,
                pattern: "*_filtered.rds"
            ]
        ]
    }

    withName: 'SEURAT_ANALYSIS' {
        publishDir = [
            [
                path: { "${params.outdir}/analysis" },
                mode: params.publish_dir_mode,
                pattern: "*.{html,pdf,png,rds,h5ad,csv}"
            ]
        ]
    }

    withName: 'SCRUBLET' {
        publishDir = [
            path: { "${params.outdir}/doublets" },
            mode: params.publish_dir_mode,
            pattern: "*.{tsv,png}"
        ]
    }

    withName: 'CELLRANGER_COUNT' {
        publishDir = [
            path: { "${params.outdir}/cellranger" },
            mode: params.publish_dir_mode
        ]
    }
}
