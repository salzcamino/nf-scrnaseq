// AWS Batch Execution Profile
// For running on Amazon's Batch service with EC2 or Fargate
// Prerequisites: AWS CLI configured, IAM permissions, compute environment setup

profiles {
    aws {
        process {
            executor = 'awsbatch'
            queue = 'default'
            
            // Resource specifications for AWS Batch
            cpus   = { check_max( 4 * task.attempt, 'cpus' ) }
            memory = { check_max( 16.GB * task.attempt, 'memory' ) }
            time   = { check_max( 12.h * task.attempt, 'time' ) }
            
            // Process-specific resources
            withLabel: process_low {
                cpus   = { check_max( 2, 'cpus' ) }
                memory = { check_max( 4.GB * task.attempt, 'memory' ) }
                time   = { check_max( 4.h * task.attempt, 'time' ) }
                queue  = 'default'
            }
            
            withLabel: process_medium {
                cpus   = { check_max( 4, 'cpus' ) }
                memory = { check_max( 16.GB * task.attempt, 'memory' ) }
                time   = { check_max( 12.h * task.attempt, 'time' ) }
                queue  = 'default'
            }
            
            withLabel: process_high {
                cpus   = { check_max( 8, 'cpus' ) }
                memory = { check_max( 32.GB * task.attempt, 'memory' ) }
                time   = { check_max( 24.h * task.attempt, 'time' ) }
                queue  = 'high-memory'  // Use GPU queue if available
            }
        }
        
        // AWS Batch executor configuration
        executor {
            name = 'awsbatch'
            awscli = '/usr/local/bin/aws'  // Path to AWS CLI
            maxRetries = 3
            maxErrors = '-1'
        }
        
        // AWS-specific settings
        aws {
            region = 'us-east-1'  // Change to your region
            batch {
                // Compute environment name (must be created beforehand)
                computeEnvironment = 'nf-scrnaseq-compute-env'
                
                // Job queue names
                jobQueue = [
                    'default': 'nf-scrnaseq-queue',
                    'high-memory': 'nf-scrnaseq-highmem-queue'
                ]
            }
        }
        
        // Container configuration for AWS Batch
        docker.enabled = true
        docker.runOptions = '-v /tmp:/tmp'
        
        // Alternative: Use Singularity on AWS Batch
        // singularity.enabled = true
        
        // S3 storage configuration for AWS Batch
        // Output should be written to S3 for persistence
        params {
            outdir = 's3://my-bucket/scrnaseq-results'  // Change to your bucket
        }
    }
}
